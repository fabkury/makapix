# Makapix — Pixel Art Social Network (Full Project Spec)

> **Purpose of this document**: a single, thorough specification for future AI models and contributors that explains exactly what to build, how it behaves, how it is secured, and how it runs cheaply on a single VPS. This project prioritizes simplicity, low cost, and predictable performance for ≤10k MAU.

---

## 1. Vision & Scope

**Makapix** is a lightweight social network centered on pixel art. It minimizes hosting and bandwidth costs by **not** hosting artworks or user profile pages on its own server. Instead, it relies on third parties (initially **GitHub Pages**) to host both the artworks and per-user static profile sites containing JSON manifests that describe those artworks.

Makapix focuses on the social layer: **metadata**, **search**, **promotion**, **comments**, **reactions**, **moderation**, and **real-time notifications** (via MQTT) that help web and physical “players” display artworks promptly.

### 1.1 Core Goals
- Operate on an inexpensive VPS with predictable costs.
- Support ≤10k MAU with a simple, robust design.
- Keep the server CPU/memory/storage footprint small by offloading heavy/static assets.
- Deliver quick updates, infinite scrolling feeds, and a clean moderation toolset.

### 1.2 Non-Goals
- No direct messaging.
- No hosting of images or large binaries on Makapix servers (thumbnails are optional and strictly bounded if introduced later).
- No non-pixel-art posts.

---

## 2. User Types & Capabilities

### 2.1 Regular Users
- Create/delete their own profiles (no undelete).
- Hide/unhide their profiles.
- Post pixel artworks (as references/hotlinks) with descriptions.
- Delete their own posts (no undelete).
- Hide their own posts from public view (still visible to admins/mods).
- Browse/search user profiles and posts by keywords and/or badges.
- Browse/search by hashtags.
- React to a post with **up to 5 emojis**; can remove/undo each emoji.
- Comment on artworks; comments can be **threaded up to depth 2**; max **1,000 comments** per post.
- Create/edit/delete **playlists** consisting of existing posts.
- Report users, reports posts (art or playlist), and report comments.
- Gain/lose **reputation** points displayed publicly.

### 2.2 Moderators (Volunteers)
- All user privileges.
- Ban/unban users.
- Hide/unhide user profiles.
- Hide/unhide posts.
- Delete/undelete posts deleted by moderators.
- Delete/undelete comments deleted by moderators.
- Post **moderator-only notes** on posts (visible only to staff).
- Access “recent users” and “recent posts” lists.
- Promote posts to special categories; demote them.
- Award/remove badges on profiles.
- Grant/remove reputation points.

### 2.3 Site Owner
- Promote/demote users to/from moderator status.
- All moderator privileges.
- **Owner role is immutable** via normal APIs; only manual DB intervention can remove owner or assign owner to someone else.

---

## 3. Key Concepts

- **Post**: either an individual **artwork** or a **playlist** of existing artworks.
- **Profile Site**: a static site hosted on GitHub Pages (or similar), generated by the client app and relayed via the server’s GitHub App to the user’s repo.
- **Manifest**: JSON file(s) within a profile repo describing artworks and metadata (hashes, canvas sizes, tags, etc.).
- **Hotlink**: the server never stores or serves the image bytes. The UI embeds the image URLs from the user’s Pages site.
- **Conformance**: the server validates manifests and hotlinks (type/size/canvas whitelist). Profiles or posts that fail validation become **non-conformant** and are hidden by default.
- **MQTT Notifications**: tiny messages announcing new/updated posts so “players” can fetch the images directly from GitHub Pages.

---

## 4. Third-Party Hosting Model

- **Primary host**: GitHub Pages per-user repository.
- The **client-side generator** (running in the user’s browser) assembles static pages + manifest(s), then uploads a ZIP to Makapix.
- The **Makapix server** validates, then commits to the user’s repo via a **GitHub App** installation, avoiding admin passwords and minimizing server-side rendering.
- Manifests include each artwork’s **URL**, **sha256 hash**, **file size**, **MIME type**, **canvas size** (from an allowlist), **title/description**, and **hashtags**.
- The server maintains **hash pinning**: it records the expected hash/size/mime and periodically verifies the remote content. Any mismatch auto-flags the post as **non-conformant** and hides it from feeds.

---

## 5. Validation & Content Rules

### 5.1 Allowed Image Types
- `image/png`, `image/jpeg`, `image/gif`.
- **Disallowed**: `image/svg+xml` and any exotic/animated vector formats (to avoid script injection).

### 5.2 Canvas Sizes (examples; configurable)
- 64×64, 96×64, 128×64, 128×128, 160×128, 240×135, 240×240, etc.
- Exact list is centrally configured; posts must match one.

### 5.3 File Size
- Typical maximum **≤ 350 KB** per artwork (configurable). Different categories may impose lower caps.

### 5.4 Manifests
- JSON Schema enforced server-side:
  - required fields, strict types, max lengths (e.g., title 120, description 1,000), hashtags `[a-z0-9_]{1,32}`.
  - NFC unicode normalization; reject control characters.

### 5.5 External Fetch Policy
- Server fetches are **allowlisted** to safe hosts (initially `*.github.io`, `raw.githubusercontent.com`).
- Deny private IP ranges/loopback/link-local; no redirects to private IPs; HEAD/GET with small timeouts & byte limits.

### 5.6 Non-Conformance Lifecycle
- When invalid: profile/post is marked **non-conformant** → hidden from feeds and search by default.
- After **1 year**, re-check; if still invalid, the **account is deactivated**, and its posts removed from indexes.
- Power users can opt-in to “show non-conformant content” (toggle).

---

## 6. Data Model (Postgres)

> All IDs are UUIDv7 (or ULIDs). Created/updated timestamps on every row. Soft-delete fields where moderators can restore; hard-delete for user-self-deletes as spec requires.

- **users**: `id`, `github_user_id`, `handle`, `display_name`, `bio_text`, `avatar_url`, `reputation`, `is_moderator`, `is_owner`, `hidden_by_user`, `hidden_by_mod`, `non_conformant`, `deactivated`, `created_at`, `updated_at`.
- **profiles**: one row per user profile site binding: `user_id`, `repo_id`, `repo_full_name`, `pages_url`, `installation_id`, `last_checked_at`, `conformance_state`.
- **posts**: `id`, `owner_user_id`, `kind` (art|playlist), `title`, `description`, `hashtags[]`, `visible`, `hidden_by_user`, `hidden_by_mod`, `non_conformant`, `promoted_flags` (bitset or enum array), `created_at`, `updated_at`.
- **art_refs** (for `kind=art`): `post_id`, `image_url`, `sha256`, `byte_len`, `mime`, `canvas_w`, `canvas_h`.
- **playlists**: `post_id` (the playlist), `entry_order`, `child_post_id` (references a conformant post at read time).
- **reactions**: `user_id`, `post_id`, `emoji` (shortcode), `created_at`. **Unique** `(user_id, post_id, emoji)`; enforce ≤5 per `(user_id, post_id)` with trigger or check.
- **comments**: `id`, `post_id`, `author_user_id`, `parent_comment_id` (nullable), `depth` (0,1,2), `body_text`, `visible`, `deleted_by_user`, `deleted_by_mod`, `created_at`. Enforce `depth ≤ 2` and **cap 1,000 per post**.
- **reports**: `id`, `reporter_user_id`, `target_type` (user|post|comment), `target_id`, `reason_code`, `note`, `created_at`, `status` (open|actioned|dismissed).
- **badges**: `id`, `slug`, `label`, `icon_url`.
- **user_badges**: `user_id`, `badge_id`, `granted_by`, `created_at`.
- **moderation_log**: `id`, `actor_user_id`, `action`, `target_type`, `target_id`, `reason_code`, `note`, `created_at`.
- **admin_notes**: per-post, staff-only text threads: `id`, `post_id`, `author_user_id`, `body_text`, `created_at`.
- **sessions / auth**: if using cookie sessions; otherwise JWTs with short TTLs.
- **rate_limits**: optional materialized counters in Redis; in DB store strike history.

**Indexes**
- GIN/trigram indexes on `posts(title, description, hashtags)`, `users(handle, display_name)`.
- Partial indexes on `visible = true AND non_conformant = false` for fast feeds.
- Foreign key cascades where safe; explicit deletes otherwise.

---

## 7. API Surface (High-Level)

> OpenAPI can be generated later; this section defines key behaviors & constraints.

- **Auth**
  - `POST /auth/github/callback` → upsert user, bind installation.
  - Sessions via Secure, HttpOnly cookies (SameSite=Lax) or short-lived JWT.

- **Users & Profiles**
  - `GET /users/:id` (public view filters applied).
  - `POST /users/me/hide|unhide|delete`.
  - `GET /users/recent` (mods only).
  - `POST /profiles/connect` (bind GitHub installation + repo); `GET /profiles/me`.

- **Publishing**
  - `POST /publish/upload` → accepts client ZIP; validates (schema/mime/canvas/hash) → enqueue **relay** job.
  - `GET /publish/jobs/:id` (status: queued/running/success/fail with reason).

- **Posts**
  - `POST /posts` (create art/playlist metadata row) — usually part of publish flow.
  - `GET /posts/:id` (filters visibility; playlist resolves only visible child posts).
  - `DELETE /posts/:id` (user hard-delete); `POST /posts/:id/hide|unhide` (user or mod).
  - `GET /posts/recent`, `GET /posts/promoted`.

- **Reactions**
  - `POST /posts/:id/reactions` ({emoji}) — enforces ≤5 per user/post.
  - `DELETE /posts/:id/reactions/:emoji`.

- **Comments**
  - `POST /posts/:id/comments` (depth 0 or reply with parent id for depth 1/2); plain text only.
  - `DELETE /comments/:id` (user hard-delete); mods can soft-delete/undelete.
  - `GET /posts/:id/comments` (paginated, tree-flattened with parent-first order).

- **Search & Indexes**
  - `GET /search?q=...` (users, posts, hashtags; keyset pagination).
  - `GET /hashtags/:tag`.

- **Moderation** (mods/owner only)
  - `POST /moderation/users/:id/ban|unban|hide|unhide`.
  - `POST /moderation/posts/:id/hide|unhide|delete|undelete|promote|demote`.
  - `POST /moderation/comments/:id/hide|unhide|delete|undelete`.
  - `POST /moderation/users/:id/badges` (grant/remove), reputation +/-.
  - `GET /moderation/reports`, `POST /moderation/reports/:id/resolve`.
  - `POST /moderation/posts/:id/notes` (admin-only note).

- **Reports**
  - `POST /reports` (user|post|comment with reason); `GET /reports/:id` (mods).

- **MQTT**
  - `GET /mqtt/cert` (issue per-device client TLS cert under authenticated user account; short TTL).

- **System**
  - `GET /health`, `GET /metrics` (prometheus), `GET /version`.

---

## 8. Web Frontend (UX Overview)

- **Home**: infinite-scroll feed of **promoted** artworks (hotlinked images).
- **Explore**: recent posts, trending tags, profiles; search.
- **Profile**: user info + timeline; non-conformant badge if applicable; toggle to view if opted-in.
- **Post**: artwork with reactions and comments (tree up to depth 2).
- **Playlists**: list of artworks; non-visible children are omitted with a note.
- **Publish Flow**: client-side generator (drag/drop or picker) → validate preview → submit ZIP → status page.
- **Moderation Console**: recent users/posts, bulk actions, reports queue, notes, audit view.

---

## 9. MQTT Protocol (Players)

- **Broker**: Eclipse Mosquitto on the same VPS; TLS mandatory; no anonymous.
- **Auth**: client TLS certificates minted by the web server; per-device mapping; revocable.
- **Topics** (examples):
  - `makapix/posts/new` → minimal payload (post_id, owner, title, urls, hash).
  - `makapix/posts/new/{owner_handle}` → owner-specific stream.
  - `makapix/system/notice` → service messages.
- **QoS**: 1 (at-least-once). **No retained** for high-churn topics.
- **Limits**: payload ≤ 8 KB; rate-limited server-side publish; per-client inflight caps.

---

## 10. Security Architecture

### 10.1 Highlights
- **Hash pinning** for all images; periodic re-verify; auto-hide on mismatch.
- **Host allowlist** for all fetches; SSRF protections; tight timeouts and byte caps.
- **Strict JSON Schema** + UTF-8 NFC normalization; size and depth caps everywhere.
- **Disallow SVG**; magic-byte sniffing for actual type.
- **CSP** (`default-src 'self'; img-src 'self' https://*.github.io data:; frame-src 'none'; script-src 'self'`), `X-Frame-Options: DENY`, `Referrer-Policy: no-referrer`.
- **CSRF** protection for cookies; or use short-lived JWT with same-origin-only refresh endpoints.
- **RBAC** wholly server-enforced; owner immutability in DB (constraint or guarded proc).
- **Rate limiting** (per-IP and per-user) and flood control on all mutating endpoints.
- **Audit trails** for all moderator actions; quick takedown flow.
- **MQTT ACLs**: end-user clients can **subscribe only**; only server publishes to `makapix/posts/*`.

### 10.2 Abuse & Spam Controls
- CAPTCHA/proof-of-work for first N actions/day.
- Shadow-ban mode for suspicious accounts.
- Link sanitizer for comment auto-linking; no HTML allowed.

---

## 11. Operational Model

### 11.1 Single VPS Layout (Dockerized)
- **Reverse proxy**: Caddy/Nginx (TLS termination, gzip/brotli, HTTP/2/3).
- **API**: Go or Node/TS server.
- **DB**: Postgres 14+ (on the same VPS initially).
- **Cache/Queue**: Redis (rate limits, queues, sessions if used).
- **MQTT**: Mosquitto with TLS.
- **Background workers**: validator, re-verifier, index refresh.
- **Static frontend**: built assets served by the proxy (or behind the API server).

### 11.2 Observability
- **Metrics**: Prometheus endpoint; basic dashboards.
- **Logs**: structured JSON logs; redact secrets.
- **Alerts**: simple uptime check + error-rate thresholds.

### 11.3 Backups & DR
- Nightly `pg_dump` encrypted to off-box storage.
- Weekly snapshot of the VPS (optional).
- Monthly restore test.

---

## 12. Performance & Capacity

- Target ≤ 100 ms p95 for read endpoints under normal load.
- Read scaling via HTTP caching (Cloudflare free) for list pages and search results.
- Writes are low volume by design; ensure idempotent publish jobs.
- Search: Postgres GIN/trigram + keyset pagination.

---

## 13. Cost Envelope

- **Compute**: one small VPS (e.g., 2 vCPU, 2–4 GB). ~ $6–$15/mo depending on provider.
- **Domain**: ~$10–$15/year.
- **Backups**: snapshots or DIY object-store; a few dollars/month or included.
- **CDN**: Cloudflare free tier enough at start.
- **MQTT**: Mosquitto (free).

Total initial monthly: **~$6–$16** (lean to comfortable).

---

## 14. Testing Strategy

- **Contract tests** for schema validation and all visibility rules.
- **Security tests**: SSRF blocklist, SVG rejection, XSS escaping, rate-limits.
- **Load tests**: read-heavy (feed scroll) + bursty writes (reactions/comments).
- **E2E**: publish flow → repo updated → post visible → MQTT notification consumed by a test client.

---

## 15. Roadmap (MVP → v1 → v1.1)

**MVP (ship fast)**
- GitHub OAuth, install & bind repo.
- Client-side generator → ZIP upload → relay commit.
- Posts (art), reactions (≤5), comments (depth 2, cap 1,000), hashtags.
- Simple search, promoted feed, profile pages.
- Basic moderation: hide/unhide, ban/unban, reports queue.
- MQTT new-post notifications.
- Non-conformance detection & toggle.

**v1**
- Playlists.
- Badges & reputation adjustments.
- Admin notes, full audit log UI.
- Validator improvements (hash pinning, scheduled re-verifies).

**v1.1**
- Optional thumbnail proxy for privacy (strict limits).
- Advanced rate limiting and anomaly detection.
- Export tools (CSV/JSON) for moderation and audits.

---

## 16. Risks & Mitigations (Quick List)

- **GitHub Pages soft limits** → per-user repos; hash pinning; defer thumbnails.
- **SSRF via validators** → allowlist hosts; block private nets.
- **XSS via metadata** → plain text + CSP.
- **Spam/fraud** → rate limits, CAPTCHA, uniqueness constraints.
- **Moderation mistakes** → audit log + reversible staff deletes.
- **Secrets leakage** → env-only, minimal scopes, rotate keys.

---

## 17. Glossary

- **Conformant**: passes schema, type, canvas, and hash checks.
- **Non-conformant**: failed checks; hidden by default; rechecked on schedule.
- **Promoted**: featured by staff for the front page.
- **Playlist**: ordered list of post IDs; only visible children render.
- **Player**: web or physical client that subscribes to MQTT and displays artworks.

---

## 18. Implementation Notes (Language-Agnostic)

- Use strict typing, small modules, and clear boundaries: **API**, **Relay**, **Validator**, **Workers**.
- Prefer idempotent handlers (publish jobs, moderation actions).
- Keyset pagination for infinite scroll; no OFFSET.
- DB constraints encode invariants (comment depth, reaction uniqueness, owner immutability bypassed only by DBA).
- Minimize 3rd-party libs; keep the codebase small and auditable.

---

**End of Spec**

