# =============================================================================
# Makapix Stack - VPS Deployment
# =============================================================================
#
# This compose file is for VPS DEPLOYMENT ONLY (dev.makapix.club staging).
# For local development, use the root docker-compose.yml instead.
#
# IMPORTANT: The web service runs in PRODUCTION MODE (not dev mode).
# This is intentional — dev mode causes styled-jsx errors on mobile browsers.
#
# Before deploying, always check for orphan containers:
#   docker ps | grep makapix
#
# Common commands (run from deploy/stack/):
#   docker compose up -d                        # Start all services
#   docker compose build --no-cache web         # Rebuild after changes
#   docker compose down web && docker compose up -d web  # Restart web
#   docker compose logs -f web                  # View web logs
#
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Caddy Reverse Proxy (auto-discovers containers via Docker labels)
  # ---------------------------------------------------------------------------
  caddy:
    image: lucaslorentz/caddy-docker-proxy:${CADDY_DOCKER_PROXY_TAG}
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "127.0.0.1:2019:2019"
    environment:
      - CADDY_INGRESS_NETWORK=caddy_net
      - ACME_AGREE=true
      - CADDY_ADMIN=0.0.0.0:2019
      - EMAIL=${ACME_EMAIL}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - caddy_data:/data
      - caddy_config:/config
      - /var/log/caddy:/var/log/caddy
      # Mount vault for HTTP file serving (vault.makapix.club)
      - ${VAULT_HOST_PATH}:/srv/vault:ro
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "10"
    networks:
      - caddy_net

  # ---------------------------------------------------------------------------
  # CTA (Call-To-Action) - Static marketing site at makapix.club
  # ---------------------------------------------------------------------------
  cta:
    image: caddy:${CADDY_TAG}
    container_name: makapix-cta
    restart: unless-stopped
    volumes:
      - ../../apps/cta:/usr/share/caddy:ro
    labels:
      caddy: ${ROOT_DOMAIN}, www.${ROOT_DOMAIN}
      caddy.encode: "gzip zstd"
      # Note: Removed "includeSubDomains" to allow HTTP access to vault.makapix.club
      # HSTS still applies to makapix.club itself, just not subdomains
      caddy.header.Strict-Transport-Security: "max-age=31536000"
      caddy.header.Content-Security-Policy: "default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https:"
      caddy.header.X-Content-Type-Options: "nosniff"
      caddy.header.Referrer-Policy: "strict-origin-when-cross-origin"
      caddy.reverse_proxy: "{{upstreams 80}}"
      caddy.log.output: "file /var/log/caddy/access.log"
      caddy.log.format: "json"
      caddy.log.level: "INFO"
    networks:
      - caddy_net

  # ---------------------------------------------------------------------------
  # Vault HTTP Labels - HTTP-only static file server for physical players
  # ---------------------------------------------------------------------------
  # Serves artwork files via plain HTTP for IoT devices that benefit from
  # reduced TLS overhead. Files are served directly by the Caddy proxy container
  # (via the /srv/vault volume mount on the caddy service above).
  #
  # URL pattern: http://vault.makapix.club/a1/b2/c3/{storage_key}.png
  #
  # ⚠️  SECURITY NOTE: This serves files without authentication.
  #     Access control is NOT enforced at this level (same as HTTPS vault).
  #     Hidden/deleted artwork restrictions rely on URL obscurity.
  #
  # The vault container below exists only to provide the Caddy labels.
  # The actual file serving is done by the main Caddy proxy.
  # ---------------------------------------------------------------------------
  vault:
    image: alpine:latest
    container_name: makapix-vault
    restart: unless-stopped
    # Minimal container - just needs to exist for its labels
    command: ["sleep", "infinity"]
    labels:
      # HTTP-only subdomain for vault files (http:// prefix = no HTTPS)
      caddy: http://${VAULT_DOMAIN:-vault.makapix.club}
      # Serve static files from vault directory (mounted in caddy container)
      caddy.file_server: "*"
      caddy.root: "* /srv/vault"
      # Enable compression for efficiency
      caddy.encode: "gzip"
      # CORS headers for cross-origin access from players/browsers
      caddy.header.Access-Control-Allow-Origin: "*"
      # Security headers
      caddy.header.X-Content-Type-Options: "nosniff"
      # Logging
      caddy.log.output: "file /var/log/caddy/vault-access.log"
      caddy.log.format: "json"
      caddy.log.level: "INFO"
    networks:
      - caddy_net

  # ---------------------------------------------------------------------------
  # Web Application (Next.js) - Staging at dev.makapix.club
  # ---------------------------------------------------------------------------
  # ⚠️  PRODUCTION MODE: Uses optimized build (not hot reload)
  #
  # The Dockerfile runs `npm run build` and serves via standalone server.
  # This avoids styled-jsx runtime errors on mobile browsers that occur in dev mode.
  #
  # Container name: makapix-web (NOT makapix-web-1)
  # If you see makapix-web-1, that's from the root docker-compose.yml — stop it!
  # ---------------------------------------------------------------------------
  web:
    # Profile "web" is preferred; "dev" kept for backwards compatibility
    profiles: ["web", "dev"]
    build:
      context: ../..
      dockerfile: web/Dockerfile
      args:
        # These are baked into the JS bundle at build time
        - NEXT_PUBLIC_API_BASE_URL=https://dev.makapix.club
        - NEXT_PUBLIC_MQTT_WS_URL=wss://dev.makapix.club/mqtt
    container_name: makapix-web
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - HOST=0.0.0.0
      - PORT=${WEB_APP_PORT:-${DEV_APP_PORT:-3000}}
      - NEXT_TELEMETRY_DISABLED=1
      # Runtime env vars (for server-side code)
      - NEXT_PUBLIC_API_BASE_URL=https://dev.makapix.club
      - NEXT_PUBLIC_MQTT_WS_URL=wss://dev.makapix.club/mqtt
    labels:
      # Caddy auto-routing via label
      caddy: ${WEB_DOMAIN:-${DEV_DOMAIN}}
      caddy.header.X-Robots-Tag: "noindex, nofollow, noarchive"
      # MQTT WebSocket proxy at /mqtt path (proxies to makapix-mqtt-1:9001)
      caddy.@mqtt.path: /mqtt
      caddy.handle_0: "@mqtt"
      caddy.handle_0.reverse_proxy: makapix-mqtt-1:9001
      # Default: proxy to Next.js web app
      caddy.handle_1.reverse_proxy: "{{upstreams ${WEB_APP_PORT:-${DEV_APP_PORT:-3000}}}}"
    # Keep Next.js static assets across deploys so older clients (especially mobile)
    # with cached HTML don't 404 on hashed chunks after a redeploy.
    volumes:
      - web_next_static:/app/.next/static
    networks:
      - caddy_net

  # ---------------------------------------------------------------------------
  # Piskel Editor - Pixel art editor at piskel.makapix.club
  # ---------------------------------------------------------------------------
  piskel:
    build:
      context: ../../apps/piskel
      dockerfile: Dockerfile
    container_name: makapix-piskel
    restart: unless-stopped
    labels:
      # Caddy auto-routing via label
      caddy: piskel.makapix.club
      caddy.encode: "gzip zstd"
      # Security headers
      caddy.header.X-Content-Type-Options: "nosniff"
      # Allow iframe embedding from dev.makapix.club
      caddy.header.Content-Security-Policy: "frame-ancestors 'self' https://dev.makapix.club"
      # Reverse proxy to container's Caddy
      caddy.reverse_proxy: "{{upstreams 80}}"
    networks:
      - caddy_net

  # ---------------------------------------------------------------------------
  # Pixelc Editor - Pixel art editor at pixelc.makapix.club
  # ---------------------------------------------------------------------------
  pixelc:
    build:
      context: /opt/Pixelc
      dockerfile: Dockerfile
    container_name: makapix-pixelc
    restart: unless-stopped
    labels:
      # Caddy auto-routing via label
      caddy: pixelc.makapix.club
      caddy.encode: "gzip zstd"
      # Security headers
      caddy.header.X-Content-Type-Options: "nosniff"
      caddy.header.Cross-Origin-Opener-Policy: "same-origin"
      caddy.header.Cross-Origin-Embedder-Policy: "require-corp"
      # Allow iframe embedding from dev.makapix.club
      caddy.header.Content-Security-Policy: "frame-ancestors 'self' https://dev.makapix.club"
      # Reverse proxy to container's Caddy
      caddy.reverse_proxy: "{{upstreams 80}}"
    networks:
      - caddy_net

  # ---------------------------------------------------------------------------
  # Redis Cache - For caching and rate limiting
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: makapix-redis
    restart: unless-stopped
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - caddy_net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  caddy_net:
    external: true

volumes:
  caddy_data:
    external: true
    name: makapix-stack_caddy_data
  caddy_config:
    external: true
    name: makapix-stack_caddy_config
  web_next_static:
  redis_data:
