# =============================================================================
# Makapix Stack - VPS Deployment
# =============================================================================
#
# This compose file is for VPS DEPLOYMENT ONLY (dev.makapix.club staging).
# For local development, use the root docker-compose.yml instead.
#
# IMPORTANT: The web service runs in PRODUCTION MODE (not dev mode).
# This is intentional — dev mode causes styled-jsx errors on mobile browsers.
#
# Before deploying, always check for orphan containers:
#   docker ps | grep makapix
#
# Common commands (run from deploy/stack/):
#   docker compose up -d                        # Start all services
#   docker compose build --no-cache web         # Rebuild after changes
#   docker compose down web && docker compose up -d web  # Restart web
#   docker compose logs -f web                  # View web logs
#
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Caddy Reverse Proxy (auto-discovers containers via Docker labels)
  # ---------------------------------------------------------------------------
  caddy:
    image: lucaslorentz/caddy-docker-proxy:${CADDY_DOCKER_PROXY_TAG}
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "127.0.0.1:2019:2019"
    environment:
      - CADDY_INGRESS_NETWORK=caddy_net
      - ACME_AGREE=true
      - CADDY_ADMIN=0.0.0.0:2019
      - EMAIL=${ACME_EMAIL}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - caddy_data:/data
      - caddy_config:/config
      - /var/log/caddy:/var/log/caddy
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "10"
    networks:
      - caddy_net

  # ---------------------------------------------------------------------------
  # CTA (Call-To-Action) - Static marketing site at makapix.club
  # ---------------------------------------------------------------------------
  cta:
    image: caddy:${CADDY_TAG}
    container_name: makapix-cta
    restart: unless-stopped
    volumes:
      - ../../apps/cta:/usr/share/caddy:ro
    labels:
      caddy: ${ROOT_DOMAIN}, www.${ROOT_DOMAIN}
      caddy.encode: "gzip zstd"
      caddy.header.Strict-Transport-Security: "max-age=31536000; includeSubDomains; preload"
      caddy.header.Content-Security-Policy: "default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https:"
      caddy.header.X-Content-Type-Options: "nosniff"
      caddy.header.Referrer-Policy: "strict-origin-when-cross-origin"
      caddy.reverse_proxy: "{{upstreams 80}}"
      caddy.log.output: "file /var/log/caddy/access.log"
      caddy.log.format: "json"
      caddy.log.level: "INFO"
    networks:
      - caddy_net

  # ---------------------------------------------------------------------------
  # Web Application (Next.js) - Staging at dev.makapix.club
  # ---------------------------------------------------------------------------
  # ⚠️  PRODUCTION MODE: Uses optimized build (not hot reload)
  #
  # The Dockerfile runs `npm run build` and serves via standalone server.
  # This avoids styled-jsx runtime errors on mobile browsers that occur in dev mode.
  #
  # Container name: makapix-web (NOT makapix-web-1)
  # If you see makapix-web-1, that's from the root docker-compose.yml — stop it!
  # ---------------------------------------------------------------------------
  web:
    # Profile "web" is preferred; "dev" kept for backwards compatibility
    profiles: ["web", "dev"]
    build:
      context: ../..
      dockerfile: web/Dockerfile
      args:
        # These are baked into the JS bundle at build time
        - NEXT_PUBLIC_API_BASE_URL=https://dev.makapix.club
        - NEXT_PUBLIC_MQTT_WS_URL=wss://dev.makapix.club:9001
    container_name: makapix-web
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - HOST=0.0.0.0
      - PORT=${WEB_APP_PORT:-${DEV_APP_PORT:-3000}}
      - NEXT_TELEMETRY_DISABLED=1
      # Runtime env vars (for server-side code)
      - NEXT_PUBLIC_API_BASE_URL=https://dev.makapix.club
      - NEXT_PUBLIC_MQTT_WS_URL=wss://dev.makapix.club:9001
    labels:
      # Caddy auto-routing via label
      caddy: ${WEB_DOMAIN:-${DEV_DOMAIN}}
      caddy.header.X-Robots-Tag: "noindex, nofollow, noarchive"
      # Uncomment for basic auth protection:
      # caddy.basicauth./: "devuser {bcrypt}$2y$10$..."
      caddy.reverse_proxy: "{{upstreams ${WEB_APP_PORT:-${DEV_APP_PORT:-3000}}}}"
    # Keep Next.js static assets across deploys so older clients (especially mobile)
    # with cached HTML don't 404 on hashed chunks after a redeploy.
    volumes:
      - web_next_static:/app/.next/static
    networks:
      - caddy_net

networks:
  caddy_net:
    external: true

volumes:
  caddy_data:
    external: true
    name: makapix-stack_caddy_data
  caddy_config:
    external: true
    name: makapix-stack_caddy_config
  web_next_static:
