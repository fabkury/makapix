# =============================================================================
# Production Environment Overrides (EA)
# =============================================================================
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml \
#     --env-file .env.prod -p makapix-prod up -d
#
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Database
  # ---------------------------------------------------------------------------
  db:
    container_name: makapix-prod-db
    volumes:
      - pg_data_prod:/var/lib/postgresql/data
      - ../../db/init.sql:/docker-entrypoint-initdb.d/10-init.sql:ro
      - ../../db/init-users.sh:/docker-entrypoint-initdb.d/20-init-users.sh:ro

  # ---------------------------------------------------------------------------
  # Cache
  # ---------------------------------------------------------------------------
  cache:
    container_name: makapix-prod-cache

  # ---------------------------------------------------------------------------
  # MQTT - Production on port 8883
  # ---------------------------------------------------------------------------
  mqtt:
    container_name: makapix-prod-mqtt
    ports:
      - "1883:1883"
      - "8883:8883"

  # ---------------------------------------------------------------------------
  # API
  # ---------------------------------------------------------------------------
  api:
    container_name: makapix-prod-api
    environment:
      MQTT_PUBLIC_HOST: makapix.club
      MQTT_PUBLIC_PORT: 8883

  # ---------------------------------------------------------------------------
  # Worker
  # ---------------------------------------------------------------------------
  worker:
    container_name: makapix-prod-worker

  # ---------------------------------------------------------------------------
  # Web - Production routing for makapix.club
  # ---------------------------------------------------------------------------
  web:
    container_name: makapix-prod-web
    build:
      context: ../..
      dockerfile: web/Dockerfile
      args:
        - NEXT_PUBLIC_API_BASE_URL=https://makapix.club
        - NEXT_PUBLIC_MQTT_WS_URL=wss://makapix.club/mqtt
        - NEXT_PUBLIC_MQTT_WEBCLIENT_PASSWORD=${MQTT_WEBCLIENT_PASSWORD}
    environment:
      - NEXT_PUBLIC_API_BASE_URL=https://makapix.club
      - NEXT_PUBLIC_MQTT_WS_URL=wss://makapix.club/mqtt
      - NEXT_PUBLIC_MQTT_WEBCLIENT_PASSWORD=${MQTT_WEBCLIENT_PASSWORD}
    labels:
      caddy: makapix.club
      # Route /api/* to FastAPI backend
      caddy.@api.path: /api/*
      caddy.handle_0: "@api"
      caddy.handle_0.handle_path: /api/*
      caddy.handle_0.handle_path.reverse_proxy: makapix-prod-api:8000
      # MQTT WebSocket proxy
      caddy.@mqtt.path: /mqtt
      caddy.handle_1: "@mqtt"
      caddy.handle_1.reverse_proxy: makapix-prod-mqtt:9001
      # Default: proxy to Next.js
      caddy.handle_2.reverse_proxy: "{{upstreams 3000}}"

  # ---------------------------------------------------------------------------
  # Vault HTTP - Production
  # ---------------------------------------------------------------------------
  vault:
    container_name: makapix-prod-vault
    labels:
      caddy: http://vault.makapix.club
      caddy.file_server: "*"
      caddy.root: "* /srv/vault-prod"
      caddy.encode: "gzip"
      caddy.header.Access-Control-Allow-Origin: "*"
      caddy.header.X-Content-Type-Options: "nosniff"
      caddy.log.output: "file /var/log/caddy/vault-access.log"
      caddy.log.format: "json"
      caddy.log.level: "INFO"

  # ---------------------------------------------------------------------------
  # WWW Redirect
  # ---------------------------------------------------------------------------
  www-redirect:
    container_name: makapix-prod-www-redirect

  # ---------------------------------------------------------------------------
  # Piskel Editor
  # ---------------------------------------------------------------------------
  piskel:
    container_name: makapix-prod-piskel
    labels:
      caddy: piskel.makapix.club
      caddy.encode: "gzip zstd"
      caddy.header.X-Content-Type-Options: "nosniff"
      caddy.header.Content-Security-Policy: "frame-ancestors 'self' https://makapix.club"
      caddy.reverse_proxy: "{{upstreams 80}}"

  # ---------------------------------------------------------------------------
  # Pixelc Editor
  # ---------------------------------------------------------------------------
  pixelc:
    container_name: makapix-prod-pixelc
    labels:
      caddy: pixelc.makapix.club
      caddy.encode: "gzip zstd"
      caddy.header.X-Content-Type-Options: "nosniff"
      caddy.header.Cross-Origin-Opener-Policy: "same-origin"
      caddy.header.Cross-Origin-Embedder-Policy: "require-corp"
      caddy.header.Content-Security-Policy: "frame-ancestors 'self' https://makapix.club"
      caddy.reverse_proxy: "{{upstreams 80}}"

  # ---------------------------------------------------------------------------
  # Redis (rate limiting)
  # ---------------------------------------------------------------------------
  redis:
    container_name: makapix-prod-redis

volumes:
  pg_data_prod:
    external: true
    name: makapix_pg_data
